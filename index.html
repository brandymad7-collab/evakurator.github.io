<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет - Эвакуатор 24/7</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <style>
        /* Ваши существующие стили остаются без изменений */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* ... остальные стили ... */
    </style>
</head>
<body>
    <!-- Ваш существующий HTML код остается без изменений -->
    <div class="container">
        <header>
            <!-- ... ваш header ... -->
        </header>
        
        <div class="dashboard">
            <!-- ... ваш контент ... -->
        </div>
    </div>

    <!-- Модальные окна -->
    <!-- ... ваши модальные окна ... -->

    <script>
        // === КОНФИГУРАЦИЯ FIREBASE ===
        // ЗАМЕНИТЕ ЭТИ ДАННЫЕ НА ВАШИ РЕАЛЬНЫЕ КЛЮЧИ ИЗ FIREBASE CONSOLE
        const firebaseConfig = {
            apiKey: "AIzaSyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            authDomain: "yourevacuationapp.firebaseapp.com",
            projectId: "yourevacuationapp",
            storageBucket: "yourevacuationapp.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:aaaaaaaaaaaaaaaaaaaaaa"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // === СИСТЕМА АУТЕНТИФИКАЦИИ И ДАННЫХ ===
        let currentUser = null;
        let evacuationActive = false;

        // === ОСНОВНОЙ КОД ПРИЛОЖЕНИЯ ===
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем, авторизован ли пользователь
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Пользователь авторизован
                    loadUserData(user.uid);
                } else {
                    // Пользователь не авторизован
                    showGuestView();
                }
            });

            // Навигация по разделам
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    navLinks.forEach(item => item.classList.remove('active'));
                    this.classList.add('active');
                    
                    contentSections.forEach(section => section.classList.add('hidden'));
                    
                    const sectionId = this.getAttribute('data-section') + '-section';
                    document.getElementById(sectionId).classList.remove('hidden');
                });
            });

            // Открытие модальных окон
            document.getElementById('login-btn').addEventListener('click', function() {
                document.getElementById('login-modal').classList.remove('hidden');
            });

            document.getElementById('register-btn').addEventListener('click', function() {
                document.getElementById('register-modal').classList.remove('hidden');
            });

            // Закрытие модальных окон
            function setupModalClose(modalId, closeButtonId, cancelButtonId = null) {
                const modal = document.getElementById(modalId);
                const closeBtn = document.getElementById(closeButtonId);
                
                closeBtn.addEventListener('click', function() {
                    modal.classList.add('hidden');
                });
                
                if (cancelButtonId) {
                    document.getElementById(cancelButtonId).addEventListener('click', function() {
                        modal.classList.add('hidden');
                    });
                }
                
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }

            setupModalClose('login-modal', 'close-login', 'cancel-login');
            setupModalClose('register-modal', 'close-register', 'cancel-register');
            setupModalClose('edit-profile-modal', 'close-edit-profile', 'cancel-edit-profile');
            setupModalClose('edit-car-modal', 'close-edit-car', 'cancel-edit-car');

            // Регистрация через Firebase
            document.getElementById('do-register').addEventListener('click', async function() {
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const phone = document.getElementById('reg-phone').value;
                const password = document.getElementById('reg-password').value;
                
                if (name && email && phone && password) {
                    await registerUser(name, email, phone, password);
                } else {
                    alert('Заполните все поля');
                }
            });

            // Вход через Firebase
            document.getElementById('do-login').addEventListener('click', async function() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (email && password) {
                    await loginUser(email, password);
                } else {
                    alert('Заполните все поля');
                }
            });

            // Редактирование профиля
            document.getElementById('edit-profile-btn').addEventListener('click', function() {
                openEditProfileModal();
            });

            // Сохранение профиля
            document.getElementById('save-profile-btn').addEventListener('click', async function() {
                await saveProfile();
            });

            // Редактирование автомобиля
            document.getElementById('edit-car-btn').addEventListener('click', function() {
                openEditCarModal();
            });

            // Сохранение автомобиля
            document.getElementById('save-car-btn').addEventListener('click', async function() {
                await saveCar();
            });

            // Калькулятор
            document.getElementById('distance').addEventListener('input', function() {
                document.getElementById('distance-value').textContent = this.value + ' км';
                calculatePrice();
            });

            document.getElementById('car-type').addEventListener('change', calculatePrice);
            document.getElementById('urgency').addEventListener('change', calculatePrice);
            document.getElementById('night-service').addEventListener('change', calculatePrice);
            document.getElementById('tech-help').addEventListener('change', calculatePrice);
            document.getElementById('waiting').addEventListener('change', calculatePrice);

            // Вызов эвакуатора
            document.getElementById('call-evacuator').addEventListener('click', function() {
                evacuationActive = true;
                document.getElementById('evacuation-form').classList.add('hidden');
                document.getElementById('evacuation-active').classList.remove('hidden');
                
                simulateEvacuationStatus();
            });
        });

        // === FIREBASE ФУНКЦИИ ===

        // Регистрация пользователя
        async function registerUser(name, email, phone, password) {
            try {
                // Создаем пользователя в Firebase Authentication
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Сохраняем данные пользователя в Firestore
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    phone: phone,
                    joinDate: new Date().toISOString(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Создаем профиль пользователя
                await db.collection('profiles').doc(user.uid).set({
                    name: name,
                    email: email,
                    phone: phone,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('register-modal').classList.add('hidden');
                showNotification('Регистрация прошла успешно!', 'success');
                
                // Очищаем форму
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-phone').value = '';
                document.getElementById('reg-password').value = '';
                
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                alert('Ошибка регистрации: ' + error.message);
            }
        }

        // Вход пользователя
        async function loginUser(email, password) {
            try {
                await auth.signInWithEmailAndPassword(email, password);
                document.getElementById('login-modal').classList.add('hidden');
                
                // Очищаем форму
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                
            } catch (error) {
                console.error('Ошибка входа:', error);
                alert('Ошибка входа: ' + error.message);
            }
        }

        // Выход пользователя
        async function logoutUser() {
            try {
                await auth.signOut();
                showNotification('Вы вышли из системы', 'info');
            } catch (error) {
                console.error('Ошибка выхода:', error);
            }
        }

        // Загрузка данных пользователя
        async function loadUserData(userId) {
            try {
                // Загружаем основные данные пользователя
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    currentUser = {
                        uid: userId,
                        ...userDoc.data()
                    };
                    updateUIForUser();
                    
                    // Загружаем профиль
                    await loadProfile(userId);
                    
                    // Загружаем данные автомобиля
                    await loadCarData(userId);
                    
                    // Загружаем историю поездок
                    await loadTripsHistory(userId);
                }
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
            }
        }

        // Загрузка профиля
        async function loadProfile(userId) {
            try {
                const profileDoc = await db.collection('profiles').doc(userId).get();
                if (profileDoc.exists) {
                    updateProfileDisplay(profileDoc.data());
                }
            } catch (error) {
                console.error('Ошибка загрузки профиля:', error);
            }
        }

        // Загрузка данных автомобиля
        async function loadCarData(userId) {
            try {
                const carDoc = await db.collection('cars').doc(userId).get();
                if (carDoc.exists) {
                    updateCarDisplay(carDoc.data());
                }
            } catch (error) {
                console.error('Ошибка загрузки данных автомобиля:', error);
            }
        }

        // Загрузка истории поездок
        async function loadTripsHistory(userId) {
            try {
                const tripsSnapshot = await db.collection('trips')
                    .where('userId', '==', userId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const trips = [];
                tripsSnapshot.forEach(doc => {
                    trips.push({ id: doc.id, ...doc.data() });
                });
                
                updateTripsDisplay(trips);
            } catch (error) {
                console.error('Ошибка загрузки истории поездок:', error);
            }
        }

        // Сохранение профиля
        async function saveProfile() {
            try {
                const profileData = {
                    name: document.getElementById('edit-profile-name').value,
                    email: document.getElementById('edit-profile-email').value,
                    phone: document.getElementById('edit-profile-phone').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('profiles').doc(currentUser.uid).set(profileData, { merge: true });
                
                // Обновляем основные данные пользователя
                await db.collection('users').doc(currentUser.uid).update({
                    name: profileData.name,
                    email: profileData.email,
                    phone: profileData.phone
                });
                
                document.getElementById('edit-profile-modal').classList.add('hidden');
                showNotification('Профиль успешно обновлен!', 'success');
                
                // Обновляем отображение
                await loadUserData(currentUser.uid);
                
            } catch (error) {
                console.error('Ошибка сохранения профиля:', error);
                alert('Ошибка сохранения профиля: ' + error.message);
            }
        }

        // Сохранение данных автомобиля
        async function saveCar() {
            try {
                const carData = {
                    brand: document.getElementById('edit-car-brand').value,
                    model: document.getElementById('edit-car-model').value,
                    year: document.getElementById('edit-car-year').value,
                    plate: document.getElementById('edit-car-plate').value,
                    vin: document.getElementById('edit-car-vin').value,
                    color: document.getElementById('edit-car-color').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('cars').doc(currentUser.uid).set(carData, { merge: true });
                
                document.getElementById('edit-car-modal').classList.add('hidden');
                showNotification('Данные автомобиля успешно обновлены!', 'success');
                
                // Обновляем отображение
                await loadCarData(currentUser.uid);
                
            } catch (error) {
                console.error('Ошибка сохранения данных автомобиля:', error);
                alert('Ошибка сохранения: ' + error.message);
            }
        }

        // === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===

        function showGuestView() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('user-section').classList.add('hidden');
            document.getElementById('guest-message').classList.remove('hidden');
            document.getElementById('user-dashboard').classList.add('hidden');
            document.getElementById('evacuation-guest').classList.remove('hidden');
            document.getElementById('evacuation-form').classList.add('hidden');
        }

        function updateUIForUser() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('user-section').classList.remove('hidden');
            
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-avatar').textContent = currentUser.name.split(' ').map(n => n[0]).join('');
            document.getElementById('user-status').textContent = `Клиент с ${new Date(currentUser.joinDate).getFullYear()} года`;
            
            document.getElementById('guest-message').classList.add('hidden');
            document.getElementById('user-dashboard').classList.remove('hidden');
            document.getElementById('evacuation-guest').classList.add('hidden');
            document.getElementById('evacuation-form').classList.remove('hidden');
        }

        function openEditProfileModal() {
            // Заполняем форму текущими данными
            document.getElementById('edit-profile-name').value = currentUser.name || '';
            document.getElementById('edit-profile-email').value = currentUser.email || '';
            document.getElementById('edit-profile-phone').value = currentUser.phone || '';
            
            document.getElementById('edit-profile-modal').classList.remove('hidden');
        }

        function openEditCarModal() {
            // Эта функция будет заполняться при загрузке данных автомобиля
            document.getElementById('edit-car-modal').classList.remove('hidden');
        }

        function updateProfileDisplay(profileData) {
            const profileHTML = `
                <div class="info-item">
                    <div class="info-label">ФИО</div>
                    <div class="info-value">${profileData.name || 'Не указано'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Телефон</div>
                    <div class="info-value">${profileData.phone || 'Не указан'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">${profileData.email || 'Не указан'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Дата регистрации</div>
                    <div class="info-value">${new Date(currentUser.joinDate).getFullYear()} год</div>
                </div>
            `;
            
            document.getElementById('profile-info').innerHTML = profileHTML;
        }

        function updateCarDisplay(carData) {
            if (!carData.brand && !carData.model) {
                document.getElementById('car-info').innerHTML = `
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <div class="info-label">Информация об автомобиле</div>
                        <div class="info-value">Данные об автомобиле не указаны. Нажмите "Редактировать", чтобы добавить информацию.</div>
                    </div>
                `;
            } else {
                const carHTML = `
                    <div class="info-item">
                        <div class="info-label">Марка</div>
                        <div class="info-value">${carData.brand || 'Не указана'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Модель</div>
                        <div class="info-value">${carData.model || 'Не указана'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Год выпуска</div>
                        <div class="info-value">${carData.year || 'Не указан'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Госномер</div>
                        <div class="info-value">${carData.plate || 'Не указан'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">VIN</div>
                        <div class="info-value">${carData.vin || 'Не указан'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Цвет</div>
                        <div class="info-value">${carData.color || 'Не указан'}</div>
                    </div>
                `;
                document.getElementById('car-info').innerHTML = carHTML;
                
                // Заполняем форму редактирования
                document.getElementById('edit-car-brand').value = carData.brand || '';
                document.getElementById('edit-car-model').value = carData.model || '';
                document.getElementById('edit-car-year').value = carData.year || '';
                document.getElementById('edit-car-plate').value = carData.plate || '';
                document.getElementById('edit-car-vin').value = carData.vin || '';
                document.getElementById('edit-car-color').value = carData.color || '';
            }
        }

        function updateTripsDisplay(trips) {
            if (trips.length === 0) {
                document.getElementById('trips-history-content').innerHTML = `
                    <p style="text-align: center; color: #666; padding: 20px;">У вас еще не было поездок</p>
                `;
            } else {
                let tripsHTML = '<table><thead><tr><th>Дата</th><th>Маршрут</th><th>Расстояние</th><th>Стоимость</th><th>Статус</th></tr></thead><tbody>';
                
                trips.forEach(trip => {
                    tripsHTML += `
                        <tr>
                            <td>${new Date(trip.createdAt?.toDate()).toLocaleDateString('ru-RU')}</td>
                            <td>${trip.from} → ${trip.to}</td>
                            <td>${trip.distance} км</td>
                            <td>${trip.cost} руб.</td>
                            <td><span class="status status-completed">Завершена</span></td>
                        </tr>
                    `;
                });
                
                tripsHTML += '</tbody></table>';
                document.getElementById('trips-history-content').innerHTML = tripsHTML;
            }
        }

        function calculatePrice() {
            // ... ваша существующая функция calculatePrice ...
        }

        function simulateEvacuationStatus() {
            // ... ваша существующая функция simulateEvacuationStatus ...
        }

        function showNotification(message, type) {
            // ... ваша существующая функция showNotification ...
        }

        // Инициализация калькулятора
        calculatePrice();
    </script>
</body>
</html>
